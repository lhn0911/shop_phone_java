<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<body>

<div th:fragment="scripts">
  <script th:inline="javascript">
    function openAddInvoiceModal() {
      document.getElementById('addInvoiceModal').classList.remove('hidden');
      updateGrandTotal(); // Tính lại tổng khi mở modal
    }

    function closeAddInvoiceModal() {
      document.getElementById('addInvoiceModal').classList.add('hidden');
    }

    function updateAmountRow(index) {
      const row = document.querySelector(`#price-${index}`)?.closest('tr');
      if (!row) return;

      const qtyInput = row.querySelector(`[name='invoiceDetails[${index}].quantity']`);
      const priceCell = row.querySelector(`#price-${index}`);
      const totalCell = row.querySelector(`#total-${index}`);

      const qty = parseInt(qtyInput.value) || 0;
      const price = parseFloat(priceCell.dataset.price) || 0;

      const total = qty * price;
      totalCell.textContent = total.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }) + ' $';

      updateGrandTotal();
    }


    function updateGrandTotal() {
      let grandTotal = 0;
      const rows = document.querySelectorAll("table tbody tr");

      rows.forEach((row, index) => {
        const qtyInput = row.querySelector(`[name='invoiceDetails[${index}].quantity']`);
        const priceCell = row.querySelector(`#price-${index}`);

        if (qtyInput && priceCell) {
          const qty = parseInt(qtyInput.value) || 0;
          const price = parseFloat(priceCell.dataset.price) || 0;

          if (qty > 0 && price > 0) {
            grandTotal += qty * price;
          }
        }
      });

      document.getElementById("grand-total").textContent = grandTotal.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }) + ' $';
    }

    function removeDetailRow(button) {
      const row = button.closest('tr');
      if (row) {
        const qtyInput = row.querySelector("input[name*='.quantity']");
        if (qtyInput) {
          qtyInput.value = 0;
          qtyInput.dispatchEvent(new Event('input'));
        }
        row.style.display = 'none';
        updateGrandTotal();
      }
    }


    // Khởi tạo khi trang load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Page loaded, updating grand total');
      updateGrandTotal();

      // Debug: Kiểm tra data-price của các cell
      const priceCells = document.querySelectorAll('[id^="price-"]');
      priceCells.forEach((cell, index) => {
        console.log(`Price cell ${index}: data-price = ${cell.dataset.price}`);
      });
    });

  </script>
</div>

</body>
</html>